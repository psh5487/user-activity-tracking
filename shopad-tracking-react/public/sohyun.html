<html>
  <head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {packages:['wordtree']});
        
        var trackings = [
            {
              "activityLogs":[
                {"id":"1","action":"APPEND","value":"0","timestamp":"2019-11-22T04:23:22.939+0000","token":"null"},
                {"id":"2","action":"HEADER_CLICK","value":"상의","timestamp":"2019-11-22T04:23:22.426+0000","token":"null"},
                {"id":"3","action":"ITEM_CLICK","value":"슬리퍼","timestamp":"2019-11-22T04:23:22.027+0000","token":"null"},
                {"id":"4","action":"APPEND","value":"0","timestamp":"2019-11-22T04:23:21.557+0000","token":"null"}
              ]
            },
            {
              "activityLogs":[
                {"id":"5","action":"APPEND","value":"0","timestamp":"2019-11-22T04:23:21.134+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
                {"id":"6","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
                {"id":"7","action":"HEADER_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"}
              ]
            },
            {
              "activityLogs":[
                {"id":"8","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:21.134+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
                {"id":"9","action":"HEADER_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"}
              ]
            },
            {
              "activityLogs":[
                {"id":"10","action":"HEADER_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
                {"id":"11","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:21.134+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"}
              ]
            },
            {
              "activityLogs":[
                {"id":"12","action":"HEADER_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
                {"id":"13","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:21.134+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"}
              ]
            }

            // {"userId":"0",
            // "activityLogs":[
            //     {"id":"0","action":"APPEND","value":"0","timestamp":"2019-11-22T04:23:21.134+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
            //     {"id":"0","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"},
            //     {"id":"0","action":"ITEM_CLICK","value":"0","timestamp":"2019-11-22T04:23:18.400+0000","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJoYWNrZGF5IiwidXNlcl9pZHgiOjAsImV4cCI6MTU3NzA3NDk5OH0.ow4AJ7X1XwSX9MFsqN-I2XxGBgAHSlgqhvRQdIBqDJE"}
            // ]},
        ]

        google.charts.setOnLoadCallback(dataLoad);

        function dataLoad() {
            axios.get('http://localhost:8080/trackingUser/api/shopad')
            .then(function (response) {
                
                // console.log("response!");
                // console.log(response.data);

                // for(var i=0; i<response.data.length; i++){
                //   trackings[i] = response.data[i];
                // }

                drawSimpleNodeChart(trackings);
            })
            .catch(function (error) {
                console.log(error);
            });
        }

        function shadeColor(color, percent) {

          var R = parseInt(color.substring(1,3),16);
          var G = parseInt(color.substring(3,5),16);
          var B = parseInt(color.substring(5,7),16);

          R = parseInt(R * (100 + percent) / 100);
          G = parseInt(G * (100 + percent) / 100);
          B = parseInt(B * (100 + percent) / 100);

          R = (R<255)?R:255;  
          G = (G<255)?G:255;  
          B = (B<255)?B:255;  

          var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
          var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
          var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

          return "#"+RR+GG+BB;
        }

        var listData = [];
        var id = 0;
        listData[id] = [id, 'start of one cycle', -1, 1, 'black'];

        function checking(trackingsNum, activityLogsNum, parentNum){
          
          for(var i=1; i<listData.length; i++){ //listData 탐색 
            
            if( (listData[i][2] == parentNum) 
            && (listData[i][1] == trackings[trackingsNum].activityLogs[activityLogsNum].action) )
            {
              
              listData[i][4] = shadeColor(listData[i][4], -20); //글자 색깔 진해지게 
              
              if(activityLogsNum == trackings[trackingsNum].activityLogs.length-1){
                
                return [activityLogsNum, -2];
              }
            
              parentNum = listData[i][0];
              activityLogsNum ++;
            
              checking(trackingsNum, activityLogsNum, parentNum);
            }  
            
            return [activityLogsNum, parentNum];
          
          }

        }
      
        function drawSimpleNodeChart(trackings) {
            
            // console.log("trackings!")
            // console.log(trackings);
            // console.log(trackings.length);
            // console.log(trackings[0].activityLogs[0].action);
            // console.log(trackings[0].activityLogs.length);

            //첫 cycle은 먼저 넣어주기
            for(var i=0; i<trackings[0].activityLogs.length; i++){
              id++;
              listData[id] = [id, trackings[0].activityLogs[i].action, i, 1, '#63C6FF'];
            }

            console.log('cycle 전');
            console.log(listData);

            for(var i=1; i<trackings.length; i++){ //모든 cycle 조각들을 돌면서,
                
                console.log(i+'번째 cycle 전');
                console.log(listData);

                var place = checking(i, 0, 0);  ////listData를 체크하며, 추가될 위치 찾기(부모 넘버 반환) 

                console.log(place);

                if(place[1] >= 0){ //위치를 찾음. 이어지는 activityLogs 차례대로 추가해주기 
                  
                  var p = place[1];

                  for(var k=place[0]; k<trackings[i].activityLogs.length; k++){
                    id++;
                    listData[id] = [id, trackings[i].activityLogs[k].action, p, 1, '#63C6FF'];
                    p = id;
                  }
    
                }
                else{ //위치를 못 찾음 
                  console.log("no place!");
                }

            }

            //graph 그리기 위한 nodeListData
            var nodeListData = new google.visualization.arrayToDataTable([
              ['id', 'childLabel', 'parent', 'size', { role: 'style' }],
              [0, 'start of one cycle', -1, 1, 'black']
            ]);

            //console.log(listData);

            //listData를 nodeListData에 넣어주기 
            for(var i=1; i<listData.length; i++){
              if(listData[i] != undefined)
                nodeListData.addRow(listData[i]); //ex. nodeListData.addRow([9, 'Amoebae', 2, 1, 'black']);
            }

            var options = {
              wordtree: {
                format: 'explicit',
                type: 'suffix'
              }
            };

            var wordtree = new google.visualization.WordTree(document.getElementById('wordtree_explicit'));
            wordtree.draw(nodeListData, options);
        }
    </script>
  </head>
  <body>
    <div id="wordtree_explicit" ></div>
    * 자주 일어난 activity일수록, 색깔이 진해짐 <br>
  </body>
</html>